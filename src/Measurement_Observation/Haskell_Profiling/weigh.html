<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"><meta name="viewport" content="width=device-width, initial-scale=1" />

      <title>2.6.6. Weigh</title>
    
          <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/theme.css " type="text/css" />
          <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/css/s4defs-roles.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/css/iframe.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/css/admonitions.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/css/s4defs-roles.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/css/iframe.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/css/admonitions.css" type="text/css" />
      
      <!-- sphinx script_files -->
        <script src="../../../_static/documentation_options.js?v=d45e8c67"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../_static/copybutton.js?v=f281be69"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../../../_static/theme-vendors.js"></script> -->
      <script src="../../../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../../../genindex.html" />
  <link rel="search" title="Search" href="../../../search.html" />
  <link rel="next" title="2.6.7. Inspection Testing" href="inspection_testing.html" />
  <link rel="prev" title="2.6.5. Flamegraphs" href="flamegraph.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../../contents.html" class="home-link">
    
      <span class="site-name">Haskell Optimization Handbook</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">

  
    <div class="nav-item">
      <a href="../../../contents.html#haskell-optimization-handbook"
         class="nav-link ">
         Table of Contents
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../../contents.html#indices-and-tables"
         class="nav-link ">
         indices and tables
      </a>
    </div>
  



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            

  
    <div class="nav-item">
      <a href="../../../contents.html#haskell-optimization-handbook"
         class="nav-link ">
         Table of Contents
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../../contents.html#indices-and-tables"
         class="nav-link ">
         indices and tables
      </a>
    </div>
  



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../../../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../../contents.html#haskell-optimization-handbook">Table of Contents</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../Preliminaries/index.html" class="reference internal ">Preliminaries</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../index.html" class="reference internal ">Measurement, Profiling, and Observation</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../Optimizations/index.html" class="reference internal ">Optimizations</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../Case_Studies/index.html" class="reference internal ">Case Studies</a>
            

            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../../contents.html#indices-and-tables">indices and tables</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../glossary.html" class="reference internal ">Glossary</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../../contents.html">Docs</a> &raquo;</li>
    
      <li><a href="../index.html"><span class="section-number">2. </span>Measurement, Profiling, and Observation</a> &raquo;</li>
    
      <li><a href="index.html"><span class="section-number">2.6. </span>Haskell Level Probing and Profiling</a> &raquo;</li>
    
    <li><span class="section-number">2.6.6. </span><span class="incremental">Weigh</span></li>
  </ul>
  

  <ul class="page-nav">
  <li class="prev">
    <a href="flamegraph.html"
       title="previous chapter">← <span class="section-number">2.6.5. </span><span class="lightgrey">Flamegraphs</span></a>
  </li>
  <li class="next">
    <a href="inspection_testing.html"
       title="next chapter"><span class="section-number">2.6.7. </span><span class="lightgrey">Inspection Testing</span> →</a>
  </li>
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <section id="weigh">
<span id="weigh-chapter"></span><h1><span class="section-number">2.6.6. </span><span class="incremental">Weigh</span><a class="headerlink" href="#weigh" title="Link to this heading">¶</a></h1>
<p><a class="reference external" href="https://hackage.haskell.org/package/weigh">Weigh</a> is a tiny Haskell package
to measure allocations of data constructors and functions. It provides a similar
interface to <a class="reference internal" href="criterion.html#tasty-chapter"><span class="std std-ref">Criterion, Gauge, and Tasty-Bench</span></a> and is
useful to confirm that a data structure or function has the memory performance
you anticipate it to have at <em>runtime</em>. <code class="docutils literal notranslate"><span class="pre">Weigh</span></code> is easy to setup and
non-invasive; requiring no changes to source code. Thus, it is a good <em>initial</em>
tool to use before trying more advanced methods with higher setup costs, such as
<a class="reference internal" href="../Binary_Profiling/cachegrind.html#cachegrind-chapter"><span class="std std-ref">Cachegrind</span></a>.</p>
<section id="requirements">
<h2><span class="section-number">2.6.6.1. </span>Requirements<a class="headerlink" href="#requirements" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>The program must not be compiled with <code class="docutils literal notranslate"><span class="pre">-threaded</span></code>.</p></li>
<li><p>The program must not be compiled with profiling enabled.</p></li>
</ol>
<p>Weigh works by tracking the allocation and garbage collection behavior of the
runtime system. It takes snapshots before and after forcing whatever value or
function you are passing to it. Thus, it will report incorrect measurements if
another thread changes the heap unexpectedly. Similarly, it will report larger
results if the values are artificially inflated for profiling.</p>
</section>
<section id="restrictions">
<h2><span class="section-number">2.6.6.2. </span>Restrictions<a class="headerlink" href="#restrictions" title="Link to this heading">¶</a></h2>
<p>Weigh is portable, and should work anywhere GHC’s native runtime system will work.</p>
</section>
<section id="what-information-do-i-receive-from-weigh">
<h2><span class="section-number">2.6.6.3. </span>What Information Do I Receive From Weigh?<a class="headerlink" href="#what-information-do-i-receive-from-weigh" title="Link to this heading">¶</a></h2>
<p>Weigh reports a table similar to <code class="docutils literal notranslate"><span class="pre">criterion</span></code> or <code class="docutils literal notranslate"><span class="pre">gauge</span></code> except displays
allocations in bytes and garbage collections by default. For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Case<span class="w">       </span>Allocated<span class="w">  </span>GCs
<span class="o">()</span><span class="w">                 </span><span class="m">0</span><span class="w">    </span><span class="m">0</span>
<span class="m">1</span><span class="w">                  </span><span class="m">0</span><span class="w">    </span><span class="m">0</span>
True<span class="w">               </span><span class="m">0</span><span class="w">    </span><span class="m">0</span>
<span class="o">[</span><span class="m">0</span>..3<span class="o">]</span><span class="w">           </span><span class="m">192</span><span class="w">    </span><span class="m">0</span>
</pre></div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">()</span></code>, <code class="docutils literal notranslate"><span class="pre">1</span></code>, <code class="docutils literal notranslate"><span class="pre">True</span></code> do not allocate any memory. This is because
<code class="docutils literal notranslate"><span class="pre">weigh</span></code> measures <em>heap</em> allocations. Thus, anything that GHC concludes can be
allocated at compile time, floated out of <code class="docutils literal notranslate"><span class="pre">main</span></code> and treated like a constant
will return 0 allocations. The list allocates due to the use of List Ranges.
Contrast that with a static literal version:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Base<span class="w">             </span>Allocated<span class="w">  </span>GCs
<span class="o">()</span><span class="w">                       </span><span class="m">0</span><span class="w">    </span><span class="m">0</span>
<span class="m">1</span><span class="w">                        </span><span class="m">0</span><span class="w">    </span><span class="m">0</span>
True<span class="w">                     </span><span class="m">0</span><span class="w">    </span><span class="m">0</span>
<span class="o">[</span><span class="m">0</span>..3<span class="o">]</span><span class="w">                 </span><span class="m">192</span><span class="w">    </span><span class="m">0</span>
<span class="o">[</span><span class="m">0</span>,1,2,3<span class="o">]</span><span class="w">                </span><span class="m">0</span><span class="w">    </span><span class="m">0</span>
</pre></div>
</div>
<p>which does no allocation as expected.</p>
</section>
<section id="when-should-i-use-weigh">
<h2><span class="section-number">2.6.6.4. </span>When should I use Weigh<a class="headerlink" href="#when-should-i-use-weigh" title="Link to this heading">¶</a></h2>
<p>Weigh is useful in the following scenarios:</p>
<ul class="simple">
<li><p>Inspecting the memory footprint of a value, such as a data type. This could be
useful to determine whether your data type will fit in a CPU cache line or not.</p></li>
<li><p>Inspecting the memory footprint of a function. This information could inform
the decision to manually apply certain GHC optimizations that might not be
firing. Such as <a class="reference internal" href="../../Optimizations/GHC_opt/lambda_lifting.html#lambda-lifting-chapter"><span class="std std-ref">Lambda Lifting</span></a> or the
<a class="reference internal" href="../../Optimizations/GHC_opt/sat_transformation.html#sat-chapter"><span class="std std-ref">SAT transformation</span></a>.</p></li>
<li><p>Inspecting the memory footprint of a data structure or a function under a
<em>particular</em> load. This is useful information to tune the data structure
specifically for that load. For example, one might make tradeoffs that create
slower writes in exchange for faster reads if the load requires exponentially
more reads than writes.</p></li>
<li><p>Tracking the memory requirements and garbage collection pressure for phases or
sub-systems of your program, or even defining unit tests based on the output
of weigh.</p></li>
<li><p>Inspecting the performance differences of the same code compiled with
different versions of GHC.</p></li>
</ul>
</section>
<section id="how-should-i-use-weigh">
<h2><span class="section-number">2.6.6.5. </span>How should I use Weigh<a class="headerlink" href="#how-should-i-use-weigh" title="Link to this heading">¶</a></h2>
<p>Weigh’s interface is similar to criterion’s and gauge’s. Our recommendation is
to define a specific benchmark target to keep your project tidy and modular. For
example, for this chapter our toy programs are weighed through this cabal target:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">benchmark weigh</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">type</span><span class="w">            </span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">exitcode-stdio-1.0</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">default-language</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Haskell2010</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">ghc-options</span><span class="w">     </span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-O2 -fforce-recomp</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">main-is</span><span class="w">         </span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Main.hs</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">hs-source-dirs</span><span class="w">  </span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bench/Weigh</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">build-depends</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">base &gt;= 4.15</span>
<span class="w">               </span><span class="l l-Scalar l-Scalar-Plain">, containers</span>
<span class="w">               </span><span class="l l-Scalar l-Scalar-Plain">, deepseq</span>
<span class="w">               </span><span class="l l-Scalar l-Scalar-Plain">, weigh</span>
<span class="w">               </span><span class="l l-Scalar l-Scalar-Plain">, random</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">weigh</span></code> exports an API to run your code with. Here is a list of common
functions to use:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mainWith</span> <span class="pre">::</span> <span class="pre">Weigh</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">IO</span> <span class="pre">()</span></code>: Similar to <code class="docutils literal notranslate"><span class="pre">defaultMain</span></code> in criterion. This function is the
main entry point to run the tests.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">value</span> <span class="pre">::</span> <span class="pre">NFData</span> <span class="pre">a</span> <span class="pre">=&gt;</span> <span class="pre">String</span> <span class="pre">-&gt;</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">Weigh</span> <span class="pre">()</span></code>: Measure the memory
allocations of a single value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">func</span> <span class="pre">::</span> <span class="pre">NFData</span> <span class="pre">a</span> <span class="pre">=&gt;</span> <span class="pre">String</span> <span class="pre">-&gt;</span> <span class="pre">(b</span> <span class="pre">-&gt;</span> <span class="pre">a)</span> <span class="pre">-&gt;</span> <span class="pre">b</span> <span class="pre">-&gt;</span> <span class="pre">Weigh</span> <span class="pre">()</span></code>: Measure the memory
allocations that result from the input function.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wgroup</span> <span class="pre">::</span> <span class="pre">String</span> <span class="pre">-&gt;</span> <span class="pre">Weigh</span> <span class="pre">()</span> <span class="pre">-&gt;</span> <span class="pre">Weigh</span> <span class="pre">()</span></code>: Define a group of tests.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">io</span> <span class="pre">::</span> <span class="pre">NFData</span> <span class="pre">a</span> <span class="pre">=&gt;</span> <span class="pre">String</span> <span class="pre">-&gt;</span> <span class="pre">(b</span> <span class="pre">-&gt;</span> <span class="pre">IO</span> <span class="pre">a)</span> <span class="pre">-&gt;</span> <span class="pre">b</span> <span class="pre">-&gt;</span> <span class="pre">Weigh</span> <span class="pre">()</span></code>: Weigh an IO
action that is applied to the input argument <code class="docutils literal notranslate"><span class="pre">b</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">io</span> <span class="pre">::</span> <span class="pre">NFData</span> <span class="pre">a</span> <span class="pre">=&gt;</span> <span class="pre">String</span> <span class="pre">-&gt;</span> <span class="pre">IO</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">Weigh</span> <span class="pre">()</span></code>: Weigh an IO action.</p></li>
</ul>
<p>We recommend using <code class="docutils literal notranslate"><span class="pre">func</span></code> over <code class="docutils literal notranslate"><span class="pre">value</span></code> because GHC might float out a given
value and statically allocate it. Thus the measurement will not observe the
allocation. For example, consider this program:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">Foo0</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Foo0</span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Generic</span><span class="p">,</span><span class="kt">NFData</span><span class="p">)</span>

<span class="kr">data</span><span class="w"> </span><span class="kt">Foo1</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Foo1</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Generic</span><span class="p">,</span><span class="kt">NFData</span><span class="p">)</span>

<span class="kr">data</span><span class="w"> </span><span class="kt">Foo2</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Foo2</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="kt">String</span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Generic</span><span class="p">,</span><span class="kt">NFData</span><span class="p">)</span>

<span class="nf">one</span><span class="p">,</span><span class="n">two</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span>
<span class="nf">one</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="s">&quot;one&quot;</span>
<span class="nf">two</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="s">&quot;two&quot;</span>

<span class="nf">main</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">main</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">mainWith</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;()&quot;</span><span class="w">         </span><span class="nb">()</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="w">          </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;True&quot;</span><span class="w">       </span><span class="kt">True</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;[0..3]&quot;</span><span class="w">     </span><span class="p">([</span><span class="mi">0</span><span class="o">..</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Int</span><span class="p">])</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;[0,1,2,3]&quot;</span><span class="w">  </span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Int</span><span class="p">])</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;Foo0&quot;</span><span class="w">       </span><span class="kt">Foo0</span>
<span class="w">  </span><span class="n">func</span><span class="w">  </span><span class="s">&quot;Foo1-func&quot;</span><span class="w">  </span><span class="kt">Foo1</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;Foo1-value&quot;</span><span class="w"> </span><span class="p">(</span><span class="kt">Foo1</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;one&quot;</span><span class="w">        </span><span class="n">one</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;Foo2&quot;</span><span class="w">       </span><span class="p">(</span><span class="kt">Foo2</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">two</span><span class="p">)</span>
</pre></div>
</div>
<p>One might <a class="reference internal" href="../Core_Profiling/size.html#memory-footprint"><span class="std std-ref">expect</span></a> <code class="docutils literal notranslate"><span class="pre">()</span></code>, <code class="docutils literal notranslate"><span class="pre">1</span></code>, and <code class="docutils literal notranslate"><span class="pre">True</span></code> to be 0,
2 and 0 machine words respectively. However, this is not the case; here is the
output from weigh:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Running<span class="w"> </span><span class="m">1</span><span class="w"> </span>benchmarks...
Benchmark<span class="w"> </span>weigh:<span class="w"> </span>RUNNING...

Case<span class="w">        </span>Allocated<span class="w">  </span>GCs
<span class="o">()</span><span class="w">                  </span><span class="m">0</span><span class="w">    </span><span class="m">0</span>
<span class="m">1</span><span class="w">                   </span><span class="m">0</span><span class="w">    </span><span class="m">0</span>
True<span class="w">                </span><span class="m">0</span><span class="w">    </span><span class="m">0</span>
<span class="o">[</span><span class="m">0</span>..3<span class="o">]</span><span class="w">            </span><span class="m">192</span><span class="w">    </span><span class="m">0</span>
<span class="o">[</span><span class="m">0</span>,1,2,3<span class="o">]</span><span class="w">           </span><span class="m">0</span><span class="w">    </span><span class="m">0</span>
Foo0<span class="w">                </span><span class="m">0</span><span class="w">    </span><span class="m">0</span>
Foo1-func<span class="w">          </span><span class="m">16</span><span class="w">    </span><span class="m">0</span>
Foo1-value<span class="w">          </span><span class="m">0</span><span class="w">    </span><span class="m">0</span>
one<span class="w">               </span><span class="m">144</span><span class="w">    </span><span class="m">0</span>
Foo2<span class="w">              </span><span class="m">336</span><span class="w">    </span><span class="m">0</span>
Benchmark<span class="w"> </span>weigh:<span class="w"> </span>FINISH
</pre></div>
</div>
<p>Notice that built in types such as <code class="docutils literal notranslate"><span class="pre">()</span></code> and <code class="docutils literal notranslate"><span class="pre">True</span></code> do not do any allocation.
This is because these types are <a class="reference external" href="https://gitlab.haskell.org/ghc/ghc/-/wikis/commentary/compiler/wired-in">wired-in</a> to
GHC, which means that there is a single shared <code class="docutils literal notranslate"><span class="pre">()</span></code> in GHC, so our call to
<code class="docutils literal notranslate"><span class="pre">value</span> <span class="pre">&quot;()&quot;</span> <span class="pre">()</span></code> performs no allocation because it references the shared
<code class="docutils literal notranslate"><span class="pre">()</span></code>. This is also true for <code class="docutils literal notranslate"><span class="pre">True</span></code>. <code class="docutils literal notranslate"><span class="pre">1</span></code> performs no allocation <em>during the
runtime</em> of our program because GHC realizes it is a <a class="reference internal" href="../../glossary.html#term-CAF"><span class="xref std std-term">CAF</span></a> and float it
out of <code class="docutils literal notranslate"><span class="pre">main</span></code>; and similarly so for <code class="docutils literal notranslate"><span class="pre">[0,1,2,3]</span></code> and <code class="docutils literal notranslate"><span class="pre">Foo0</span></code> . In contrast,
the list ranges <code class="docutils literal notranslate"><span class="pre">[0..3]</span></code> and <code class="docutils literal notranslate"><span class="pre">([0,1,2],[3,4,5])</span></code> do perform allocation
during runtime. <code class="docutils literal notranslate"><span class="pre">Foo1-func</span></code> allocates because we used <code class="docutils literal notranslate"><span class="pre">func</span></code> which forces
the creation of <code class="docutils literal notranslate"><span class="pre">Foo1</span></code> at runtime. <code class="docutils literal notranslate"><span class="pre">Foo1-value</span></code> performs no runtime
allocation because GHC will detect it as a CAF just like <code class="docutils literal notranslate"><span class="pre">True</span></code>, <code class="docutils literal notranslate"><span class="pre">()</span></code> and
<code class="docutils literal notranslate"><span class="pre">1</span></code>. This is also why <code class="docutils literal notranslate"><span class="pre">Foo2</span></code> allocates; under the hood the <code class="docutils literal notranslate"><span class="pre">Foo2</span></code> value is
a <code class="docutils literal notranslate"><span class="pre">CAF</span></code>, and its fields <code class="docutils literal notranslate"><span class="pre">one</span></code> and <code class="docutils literal notranslate"><span class="pre">two</span></code> are shared, but <code class="docutils literal notranslate"><span class="pre">one</span></code> and
<code class="docutils literal notranslate"><span class="pre">two</span></code> are allocated at runtime via the <code class="docutils literal notranslate"><span class="pre">unpackCString#</span></code> primitive. Here is
the relevant <a class="reference internal" href="../Core_Profiling/core.html#reading-core"><span class="std std-ref">Core</span></a>:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="c1">-- RHS size: {terms: 3, types: 0, coercions: 0, joins: 0/0}</span>
<span class="kt">Main</span><span class="o">.</span><span class="n">main_v2</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Foo2</span>
<span class="p">[</span><span class="kt">GblId</span><span class="p">,</span>
<span class="w"> </span><span class="kt">Unf</span><span class="ow">=</span><span class="kt">Unf</span><span class="p">{</span><span class="kt">Src</span><span class="o">=&lt;</span><span class="n">vanilla</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="kt">TopLvl</span><span class="ow">=</span><span class="kt">True</span><span class="p">,</span><span class="w"> </span><span class="kt">Value</span><span class="ow">=</span><span class="kt">True</span><span class="p">,</span><span class="w"> </span><span class="kt">ConLike</span><span class="ow">=</span><span class="kt">True</span><span class="p">,</span>
<span class="w">         </span><span class="kt">WorkFree</span><span class="ow">=</span><span class="kt">True</span><span class="p">,</span><span class="w"> </span><span class="kt">Expandable</span><span class="ow">=</span><span class="kt">True</span><span class="p">,</span><span class="w"> </span><span class="kt">Guidance</span><span class="ow">=</span><span class="kt">IF_ARGS</span><span class="w"> </span><span class="kt">[]</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">10</span><span class="p">}]</span>
<span class="kt">Main</span><span class="o">.</span><span class="n">main_v2</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Main</span><span class="o">.</span><span class="kt">Foo2</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">two</span>


<span class="c1">-- RHS size: {terms: 1, types: 0, coercions: 0, joins: 0/0}</span>
<span class="kt">Main</span><span class="o">.</span><span class="n">one1</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="n">ghc</span><span class="o">-</span><span class="n">prim</span><span class="kt">:GHC</span><span class="o">.</span><span class="kt">Prim</span><span class="o">.</span><span class="kt">Addr</span><span class="o">#</span>
<span class="p">[</span><span class="kt">GblId</span><span class="p">,</span>
<span class="w"> </span><span class="kt">Unf</span><span class="ow">=</span><span class="kt">Unf</span><span class="p">{</span><span class="kt">Src</span><span class="o">=&lt;</span><span class="n">vanilla</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="kt">TopLvl</span><span class="ow">=</span><span class="kt">True</span><span class="p">,</span><span class="w"> </span><span class="kt">Value</span><span class="ow">=</span><span class="kt">True</span><span class="p">,</span><span class="w"> </span><span class="kt">ConLike</span><span class="ow">=</span><span class="kt">True</span><span class="p">,</span>
<span class="w">         </span><span class="kt">WorkFree</span><span class="ow">=</span><span class="kt">True</span><span class="p">,</span><span class="w"> </span><span class="kt">Expandable</span><span class="ow">=</span><span class="kt">True</span><span class="p">,</span><span class="w"> </span><span class="kt">Guidance</span><span class="ow">=</span><span class="kt">IF_ARGS</span><span class="w"> </span><span class="kt">[]</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="mi">0</span><span class="p">}]</span>
<span class="kt">Main</span><span class="o">.</span><span class="n">one1</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="s">&quot;one&quot;</span><span class="o">#</span>

<span class="c1">-- RHS size: {terms: 2, types: 0, coercions: 0, joins: 0/0}</span>
<span class="nf">one</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span>
<span class="p">[</span><span class="kt">GblId</span><span class="p">,</span>
<span class="w"> </span><span class="kt">Unf</span><span class="ow">=</span><span class="kt">Unf</span><span class="p">{</span><span class="kt">Src</span><span class="o">=&lt;</span><span class="n">vanilla</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="kt">TopLvl</span><span class="ow">=</span><span class="kt">True</span><span class="p">,</span><span class="w"> </span><span class="kt">Value</span><span class="ow">=</span><span class="kt">False</span><span class="p">,</span><span class="w"> </span><span class="kt">ConLike</span><span class="ow">=</span><span class="kt">True</span><span class="p">,</span>
<span class="w">         </span><span class="kt">WorkFree</span><span class="ow">=</span><span class="kt">False</span><span class="p">,</span><span class="w"> </span><span class="kt">Expandable</span><span class="ow">=</span><span class="kt">True</span><span class="p">,</span><span class="w"> </span><span class="kt">Guidance</span><span class="ow">=</span><span class="kt">IF_ARGS</span><span class="w"> </span><span class="kt">[]</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="mi">0</span><span class="p">}]</span>
<span class="nf">one</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">ghc</span><span class="o">-</span><span class="n">prim</span><span class="kt">:GHC</span><span class="o">.</span><span class="kt">CString</span><span class="o">.</span><span class="n">unpackCString</span><span class="o">#</span><span class="w"> </span><span class="kt">Main</span><span class="o">.</span><span class="n">one1</span>
</pre></div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">Main.Foo2</span></code> calls <code class="docutils literal notranslate"><span class="pre">one</span></code> and <code class="docutils literal notranslate"><span class="pre">two</span></code>, and that <code class="docutils literal notranslate"><span class="pre">one</span></code> is a CAF
because it has the properties <code class="docutils literal notranslate"><span class="pre">Workfree=True</span></code>, <code class="docutils literal notranslate"><span class="pre">Value=True</span></code>, and
<code class="docutils literal notranslate"><span class="pre">TopLvl=True</span></code>. But the payload of <code class="docutils literal notranslate"><span class="pre">one</span></code>, <code class="docutils literal notranslate"><span class="pre">Main.one1</span></code>, <em>is not</em> a CAF
because it is not a value and is not work free.</p>
</section>
<section id="examples">
<h2><span class="section-number">2.6.6.6. </span>Examples<a class="headerlink" href="#examples" title="Link to this heading">¶</a></h2>
<section id="better-output-by-setting-columns">
<h3><span class="section-number">2.6.6.6.1. </span>Better Output By Setting Columns<a class="headerlink" href="#better-output-by-setting-columns" title="Link to this heading">¶</a></h3>
<p>Weigh’s default configuration is good enough, but we can query for more data
than just allocations and garbage collections using the function <code class="docutils literal notranslate"><span class="pre">setColumns</span></code>:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">main</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">main</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">mainWith</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="n">setColumns</span><span class="w"> </span><span class="p">[</span><span class="kt">Case</span><span class="p">,</span><span class="w"> </span><span class="kt">Allocated</span><span class="p">,</span><span class="w"> </span><span class="kt">Max</span><span class="p">,</span><span class="w"> </span><span class="kt">Live</span><span class="p">,</span><span class="w"> </span><span class="kt">GCs</span><span class="p">,</span><span class="w"> </span><span class="kt">MaxOS</span><span class="p">]</span><span class="w"> </span><span class="c1">-- new</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;()&quot;</span><span class="w">         </span><span class="nb">()</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="w">          </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;True&quot;</span><span class="w">       </span><span class="kt">True</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;[0..3]&quot;</span><span class="w">     </span><span class="p">([</span><span class="mi">0</span><span class="o">..</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Int</span><span class="p">])</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;[0,1,2,3]&quot;</span><span class="w">  </span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Int</span><span class="p">])</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;Foo0&quot;</span><span class="w">       </span><span class="kt">Foo0</span>
<span class="w">  </span><span class="n">func</span><span class="w">  </span><span class="s">&quot;Foo1-func&quot;</span><span class="w">  </span><span class="kt">Foo1</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;Foo1-value&quot;</span><span class="w"> </span><span class="p">(</span><span class="kt">Foo1</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;one&quot;</span><span class="w">        </span><span class="n">one</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;Foo2&quot;</span><span class="w">       </span><span class="p">(</span><span class="kt">Foo2</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">two</span><span class="p">)</span>
</pre></div>
</div>
<p>which yields:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Running<span class="w"> </span><span class="m">1</span><span class="w"> </span>benchmarks...
Benchmark<span class="w"> </span>weigh:<span class="w"> </span>RUNNING...

Case<span class="w">        </span>Allocated<span class="w">  </span>Max<span class="w">  </span>Live<span class="w">  </span>GCs<span class="w">  </span>MaxOS
<span class="o">()</span><span class="w">                  </span><span class="m">0</span><span class="w">  </span><span class="m">456</span><span class="w">   </span><span class="m">456</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
<span class="m">1</span><span class="w">                   </span><span class="m">0</span><span class="w">  </span><span class="m">456</span><span class="w">   </span><span class="m">456</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
True<span class="w">                </span><span class="m">0</span><span class="w">  </span><span class="m">456</span><span class="w">   </span><span class="m">456</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
<span class="o">[</span><span class="m">0</span>..3<span class="o">]</span><span class="w">            </span><span class="m">192</span><span class="w">  </span><span class="m">504</span><span class="w">   </span><span class="m">504</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
<span class="o">[</span><span class="m">0</span>,1,2,3<span class="o">]</span><span class="w">           </span><span class="m">0</span><span class="w">  </span><span class="m">456</span><span class="w">   </span><span class="m">456</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
Foo0<span class="w">                </span><span class="m">0</span><span class="w">  </span><span class="m">456</span><span class="w">   </span><span class="m">456</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
Foo1-func<span class="w">          </span><span class="m">16</span><span class="w">  </span><span class="m">472</span><span class="w">   </span><span class="m">472</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
Foo1-value<span class="w">          </span><span class="m">0</span><span class="w">  </span><span class="m">456</span><span class="w">   </span><span class="m">456</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
one<span class="w">               </span><span class="m">144</span><span class="w">  </span><span class="m">504</span><span class="w">   </span><span class="m">504</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
Foo2<span class="w">              </span><span class="m">336</span><span class="w">  </span><span class="m">552</span><span class="w">   </span><span class="m">552</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
Benchmark<span class="w"> </span>weigh:<span class="w"> </span>FINISH
</pre></div>
</div>
<p>and now we can see total bytes allocated, the maximum residency memory, the
total amount of live data on the heap, the number of garbage collections, and
the maximum memory in use by the RTS, which in these simple examples is
always 0.</p>
</section>
<section id="observe-ghc-optimizations-on-your-data-type">
<h3><span class="section-number">2.6.6.6.2. </span>Observe GHC Optimizations on your Data Type<a class="headerlink" href="#observe-ghc-optimizations-on-your-data-type" title="Link to this heading">¶</a></h3>
<p>GHC is a good optimizing compiler and by using weigh we can investigate how GHC
is optimizing our program. Consider these data types:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">LotsOfInts</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">A</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="kt">B</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="kt">C</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="kt">D</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="kt">E</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">       </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Generic</span><span class="p">,</span><span class="kt">NFData</span><span class="p">)</span>

<span class="kr">data</span><span class="w"> </span><span class="kt">LotsOfInts2</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">A2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">B2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">C2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">D2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">E2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">F2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">G2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">H2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">          </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Generic</span><span class="p">,</span><span class="kt">NFData</span><span class="p">)</span>
</pre></div>
</div>
<p>With no optimizations taking place we would expect that a value of
<code class="docutils literal notranslate"><span class="pre">LotsOfInts</span></code> requires 3 machine words: one for the data constructor header,
one for a pointer for each field. The payloads are simply <code class="docutils literal notranslate"><span class="pre">Int</span></code> which requires
two machine words each, one for the <code class="docutils literal notranslate"><span class="pre">I#</span></code> constructor and one for the payload
<code class="docutils literal notranslate"><span class="pre">Int#</span></code>. Note that we could directly use <a class="reference internal" href="../../glossary.html#term-Unboxed"><span class="xref std std-term">unboxed</span></a> Ints (that is store
<code class="docutils literal notranslate"><span class="pre">Int#</span></code> instead of <code class="docutils literal notranslate"><span class="pre">Int</span></code> in <code class="docutils literal notranslate"><span class="pre">LotsOfInts</span></code>), each constructor would still
require three words only instead of storing pointers we would be storing the
actual payload. Let’s measure how many bytes a value of <code class="docutils literal notranslate"><span class="pre">LotsOfInts</span></code> and
<code class="docutils literal notranslate"><span class="pre">LotsOfInts2</span></code> requires:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="cm">{-# OPTIONS_GHC -O2 #-}</span>

<span class="kr">module</span><span class="w"> </span><span class="nn">Main</span><span class="w"> </span><span class="kr">where</span>

<span class="kr">import</span><span class="w"> </span><span class="nn">Weigh</span>

<span class="kr">data</span><span class="w"> </span><span class="kt">LotsOfInts</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">A</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="kt">B</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="kt">C</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="kt">D</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="kt">E</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">       </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Generic</span><span class="p">,</span><span class="kt">NFData</span><span class="p">)</span>

<span class="kr">data</span><span class="w"> </span><span class="kt">LotsOfInts2</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">A2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">B2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">C2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">D2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">E2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">F2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">G2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">H2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">I2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">          </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Generic</span><span class="p">,</span><span class="kt">NFData</span><span class="p">)</span>

<span class="c1">-- notice that we&#39;ll use both value, and func to cover our bases</span>
<span class="nf">main</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">main</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">mainWith</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="n">setColumns</span><span class="w"> </span><span class="p">[</span><span class="kt">Case</span><span class="p">,</span><span class="w"> </span><span class="kt">Allocated</span><span class="p">,</span><span class="w"> </span><span class="kt">Max</span><span class="p">,</span><span class="w"> </span><span class="kt">Live</span><span class="p">,</span><span class="w"> </span><span class="kt">GCs</span><span class="p">,</span><span class="w"> </span><span class="kt">MaxOS</span><span class="p">]</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;value: A Lot Of Ints&quot;</span><span class="w">  </span><span class="p">(</span><span class="kt">A</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="mi">1001</span><span class="p">)</span>
<span class="w">  </span><span class="n">func</span><span class="w">  </span><span class="s">&quot;func:  A Lot Of Ints&quot;</span><span class="w">  </span><span class="p">(</span><span class="kt">A</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="mi">1001</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="s">&quot;value: A Lot Of Ints2&quot;</span><span class="w"> </span><span class="p">(</span><span class="kt">A2</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="mi">1001</span><span class="p">)</span>
<span class="w">  </span><span class="n">func</span><span class="w">  </span><span class="s">&quot;func:  A Lot Of Ints2&quot;</span><span class="w"> </span><span class="p">(</span><span class="kt">A2</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="mi">1001</span>
</pre></div>
</div>
<p>which produces:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Benchmark</span> <span class="n">weigh</span><span class="p">:</span> <span class="n">RUNNING</span><span class="o">...</span>

<span class="n">Case</span>                   <span class="n">Allocated</span>  <span class="n">Max</span>  <span class="n">Live</span>  <span class="n">GCs</span>  <span class="n">MaxOS</span>
<span class="n">value</span><span class="p">:</span> <span class="n">A</span> <span class="n">Lot</span> <span class="n">Of</span> <span class="n">Ints</span>           <span class="mi">0</span>  <span class="mi">456</span>   <span class="mi">456</span>    <span class="mi">0</span>      <span class="mi">0</span>
<span class="n">func</span><span class="p">:</span>  <span class="n">A</span> <span class="n">Lot</span> <span class="n">Of</span> <span class="n">Ints</span>          <span class="mi">24</span>  <span class="mi">480</span>   <span class="mi">480</span>    <span class="mi">0</span>      <span class="mi">0</span>
<span class="n">value</span><span class="p">:</span> <span class="n">A</span> <span class="n">Lot</span> <span class="n">Of</span> <span class="n">Ints2</span>         <span class="mi">72</span>  <span class="mi">456</span>   <span class="mi">456</span>    <span class="mi">0</span>      <span class="mi">0</span>
<span class="n">func</span><span class="p">:</span>  <span class="n">A</span> <span class="n">Lot</span> <span class="n">Of</span> <span class="n">Ints2</span>         <span class="mi">96</span>  <span class="mi">480</span>   <span class="mi">480</span>    <span class="mi">0</span>      <span class="mi">0</span>
<span class="n">Benchmark</span> <span class="n">weigh</span><span class="p">:</span> <span class="n">FINISH</span>
</pre></div>
</div>
<p>We expected <code class="docutils literal notranslate"><span class="pre">LotsOfInts</span></code> to take a 3 machine words (or 24 bytes on a 64-bit
machine, 12 on a 32-bit machine) for a single value. However, we find that
instead of 24 bytes a new value allocates 0. In contrast, the function version
of <code class="docutils literal notranslate"><span class="pre">LotsOfInts</span></code> allocates 24 bytes. There are several things happening here:
First, <code class="docutils literal notranslate"><span class="pre">A</span> <span class="pre">1000</span> <span class="pre">1001</span></code> is recognized as a <a class="reference internal" href="../../glossary.html#term-CAF"><span class="xref std std-term">CAF</span></a> by GHC and allocated at
compiled time; which is why we do not see any allocation measured by weigh at
runtime. Second, GHC allocates 24 bytes for the function version because
partially applying <code class="docutils literal notranslate"><span class="pre">(A</span> <span class="pre">1000)</span></code> to <code class="docutils literal notranslate"><span class="pre">1001</span></code> requires allocating <code class="docutils literal notranslate"><span class="pre">1001</span></code> (two
words) <em>and</em> a pointer to <code class="docutils literal notranslate"><span class="pre">1001</span></code> (one word).</p>
<p>We should expect that <code class="docutils literal notranslate"><span class="pre">LotsOfInts</span></code> and <code class="docutils literal notranslate"><span class="pre">LotsOfInts2</span></code> would have identical
memory characteristics because the only difference between them is the number of
constructors (five vs nine). We find that is not the case, instead
<code class="docutils literal notranslate"><span class="pre">LotsOfInts2</span></code> allocates much more memory (3x!) than <code class="docutils literal notranslate"><span class="pre">LotsOfInts</span></code>.
Furthermore, a value of <code class="docutils literal notranslate"><span class="pre">LotsOfInts2</span></code> allocates 9 words (72 bytes), which is 6
more words than expected <em>and</em> indicates that the value was not detected as a
CAF. What we’re observing is the benefits of pointer-tagging optimizations (see
<span id="id2">Marlow <em>et al.</em> [<a class="reference internal" href="../../../contents.html#id11" title="Simon Marlow, Alexey Rodriguez Yakushev, and Simon Peyton Jones. Faster laziness using dynamic pointer tagging. SIGPLAN Not., 42(9):277–288, oct 2007. URL: https://doi.org/10.1145/1291220.1291194, doi:10.1145/1291220.1291194.">4</a>]</span>). When a datatype has 8 or less (4 or less on
32-bit machines) constructors GHC uses the last 3-bits (2-bits on 32-bit) of the
constructor’s pointer to store information about the constructor. This produces
a significant speedup and lowers memory costs in many ways: It allows the
runtime system to avoid checking the <a class="reference internal" href="../../glossary.html#term-Info-Table"><span class="xref std std-term">Info Table</span></a> for arity and payload
information, which improves branch prediction and function calls. It speeds up
case-expressions because the runtime system does not need to enter the scrutinee
to determine the constructor. Thus, it is a good idea to keep the number of
constructors for crucial datatypes at 8 or less.</p>
<p>We can double check that pointer-tagging is the culprit by removing a
constructor from <code class="docutils literal notranslate"><span class="pre">LotsOfInts2</span></code>:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">LotsOfInts2</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">A2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">B2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">C2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">D2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">E2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">F2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">G2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="kt">H2</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Int</span>
<span class="w">                 </span><span class="c1">-- now we have exactly 8 constructors</span>
<span class="w">                 </span><span class="c1">-- | I2 Int Int</span>
<span class="w">          </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Generic</span><span class="p">,</span><span class="kt">NFData</span><span class="p">)</span>
</pre></div>
</div>
<p>which produces:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Benchmark<span class="w"> </span>weigh:<span class="w"> </span>RUNNING...

Case<span class="w">                   </span>Allocated<span class="w">  </span>Max<span class="w">  </span>Live<span class="w">  </span>GCs<span class="w">  </span>MaxOS
value:<span class="w"> </span>A<span class="w"> </span>Lot<span class="w"> </span>Of<span class="w"> </span>Ints<span class="w">           </span><span class="m">0</span><span class="w">  </span><span class="m">456</span><span class="w">   </span><span class="m">456</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
func:<span class="w">  </span>A<span class="w"> </span>Lot<span class="w"> </span>Of<span class="w"> </span>Ints<span class="w">          </span><span class="m">24</span><span class="w">  </span><span class="m">480</span><span class="w">   </span><span class="m">480</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
value:<span class="w"> </span>A<span class="w"> </span>Lot<span class="w"> </span>Of<span class="w"> </span>Ints2<span class="w">          </span><span class="m">0</span><span class="w">  </span><span class="m">456</span><span class="w">   </span><span class="m">456</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
func:<span class="w">  </span>A<span class="w"> </span>Lot<span class="w"> </span>Of<span class="w"> </span>Ints2<span class="w">         </span><span class="m">24</span><span class="w">  </span><span class="m">480</span><span class="w">   </span><span class="m">480</span><span class="w">    </span><span class="m">0</span><span class="w">      </span><span class="m">0</span>
Benchmark<span class="w"> </span>weigh:<span class="w"> </span>FINISH
</pre></div>
</div>
<p>And now <code class="docutils literal notranslate"><span class="pre">LotsOfInts2</span></code> behaves exactly like <code class="docutils literal notranslate"><span class="pre">LotsOfInts</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you check the STG for the nine constructor version of <code class="docutils literal notranslate"><span class="pre">LotsOfInts2</span></code>
you’ll find that the root of the allocations come from the <code class="docutils literal notranslate"><span class="pre">Generic</span></code> and
<code class="docutils literal notranslate"><span class="pre">NFData</span></code> instances. The functions these instances generate use an extra
case-expression to scrutinize a value of <code class="docutils literal notranslate"><span class="pre">LotsOfInts2</span></code>, and in STG (and
Core) that extra case expression means extra allocation. In addition to the
extra case-expression, the nine constructor version disables <a class="reference internal" href="../../Optimizations/Code_Changes/inlining.html#inlining-chapter"><span class="std std-ref">inlining</span></a> and <a class="reference internal" href="../../Optimizations/GHC_opt/sat_transformation.html#sat-chapter"><span class="std std-ref">SAT</span></a> optimizations.</p>
</div>
</section>
</section>
<section id="summary">
<h2><span class="section-number">2.6.6.7. </span>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h2>
<p>We have explored using the <code class="docutils literal notranslate"><span class="pre">weigh</span></code> library to do a shallow inspection of the
memory performance of a data type or function. Weigh is easy to setup and low
weight, so it a useful tool before reaching for more invasive methods. One
should use weigh to collect data for memory regressions, to verify mental models
of GHC’s optimizations on data types in micro-benchmarks, or to inspect memory
behavior of a program under a particular load.</p>
</section>
<section id="references-and-further-reading">
<h2><span class="section-number">2.6.6.8. </span>References and Further Reading<a class="headerlink" href="#references-and-further-reading" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>The FPComplete <a class="reference external" href="https://www.fpcomplete.com/blog/2016/05/weigh-package/">blog post</a> on weigh</p></li>
</ol>
</section>
<section id="related-work">
<h2><span class="section-number">2.6.6.9. </span>Related Work<a class="headerlink" href="#related-work" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://github.com/def-/ghc-datasize">ghc-datasize</a></p></li>
</ol>
</section>
</section>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
  <li class="prev">
    <a href="flamegraph.html"
       title="previous chapter">← <span class="section-number">2.6.5. </span><span class="lightgrey">Flamegraphs</span></a>
  </li>
  <li class="next">
    <a href="inspection_testing.html"
       title="next chapter"><span class="section-number">2.6.7. </span><span class="lightgrey">Inspection Testing</span> →</a>
  </li>
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2022-2024, Jeffrey Young (doyougnu).
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 7.2.6 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>